- ansible.builtin.debug:
    msg: "{{ csr }}"
  delegate_to: localhost
- name: Get information on the CSR
  community.crypto.openssl_csr_info:
    content: "{{ csr }}"
  register: decoded_csr
  delegate_to: localhost
- ansible.builtin.debug:
    msg: "{{ decoded_csr }}"
  delegate_to: localhost
- name: Create a challenge
  community.crypto.acme_certificate:
    account_key_content: "{{ acme_key }}"
    account_key_passphrase: "{{ acme_key_passphrase }}"
    csr_content: "{{ csr }}"
    acme_directory: "{{ acme_directory }}"
    acme_version: "{{ acme_version }}"
    challenge: dns-01
    dest: "/tmp/{{ decoded_csr.subject.commonName }}.crt"
    fullchain_dest: "/tmp/{{ decoded_csr.subject.commonName }}_chain.crt"
  register: challenge
  delegate_to: localhost
- ansible.builtin.debug:
    msg: "{{ challenge }}"
  delegate_to: localhost
- ansible.builtin.include_tasks: create_dns_records.yml
  vars:
    acme_challenges: "{{ challenge }}"
- block:
    - ansible.builtin.include_tasks: verify_all_dns_record.yml
      vars:
        acme_challenges: "{{ challenge }}"
      when: verify_dns
    - name: Complete challenge
      community.crypto.acme_certificate:
        account_key_content: "{{ acme_key }}"
        account_key_passphrase: "{{ acme_key_passphrase }}"
        csr_content: "{{ csr }}"
        acme_directory: "{{ acme_directory }}"
        acme_version: "{{ acme_version }}"
        challenge: dns-01
        dest: "/tmp/{{ decoded_csr.subject.commonName }}.crt"
        fullchain_dest: "/tmp/{{ decoded_csr.subject.commonName }}_chain.crt"
        data: "{{ challenge }}"
      register: challenge_result
      delegate_to: localhost
    - ansible.builtin.debug:
        msg: "{{ challenge_result }}"
      delegate_to: localhost
    - name: Create a zip file with certificates
      community.general.archive:
        path:
        - "/tmp/{{ decoded_csr.subject.commonName }}.crt"
        - "/tmp/{{ decoded_csr.subject.commonName }}_chain.crt"
        dest: "/tmp/{{ decoded_csr.subject.commonName }}.zip"
        format: zip
      delegate_to: localhost
    - name: Sending an e-mail with certificate
      community.general.mail:
        host: smtp.lcmchealth.org
        port: 25
        from: ansible@lcmchealth.org (Ansible)
        to: "{{ email_recipient }}"
        subject: Ansible Generated Certificate
        body: System {{ ansible_hostname }} has been successfully provisioned.
        attach: "/tmp/{{ decoded_csr.subject.commonName }}.zip"
      delegate_to: localhost
    - name: Delete certificate files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/{{ decoded_csr.subject.commonName }}.crt"
        - "/tmp/{{ decoded_csr.subject.commonName }}_chain.crt"
        - "/tmp/{{ decoded_csr.subject.commonName }}.zip"
      delegate_to: localhost
  always:
    - ansible.builtin.include_tasks: delete_dns_records.yml
      vars:
        acme_challenges: "{{ challenge }}"
      when: challenge.challenge_data|length > 0